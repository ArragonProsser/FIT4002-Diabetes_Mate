# AWS Local credential setup with single sign on(SSO)

To create aws profile and credentials under SSO, we need to use `Okta Authenticator script` to create them in `.aws/config` file.


```
https://confluence.apps.monash.edu/display/AWS/AWS+IAM+Account+Standards
https://confluence.apps.monash.edu/display/AWS/Use+AWS+CLI+via+Okta+Authentication
```
Note: Monash VPN required to access Confluence

## Steps

### Download Okta Authenticator script

```
https://bitbucket.apps.monash.edu:8443/projects/AWS/repos/okta-authenticator/browse
```
download the file okta-auth.py and requirements.txt from the above link

### Install python3 and packages for Okta Auth script

Need to install python3, and pip (python package manager)

If you don't have python3 installed, then install it first. pip will be installed automatically.
```
For Mac 
brew install python3
```

Install pacakges for Okta Auth script
```
pip3 install -r requirements.txt
```
or
```
pip3 install arrow awscli boto3 botocore certifi chardet docutils idna jmespath lxml python-dateutil requests s3transfer six urllib3
```

### Run Okta Authenticator script

```
python3 ./okta-auth.py -e [your aws manager account] -r [aws role name]
```
[aws role name]: this is one of your aws role names

e.g.
```
python3 ./okta-auth.py -e "mgr-dkim0026@monash.edu" -r "optimalme-npd-poweruser"

password: <= your mgr account password
Authenticated to optimalme-npd-poweruser; call using aws <command> --profile optimalme-npd-poweruser
```

Once it all goes well, check ./aws/config file

There should be [profile optimalme-npd-poweruser] section like belows
```
[profile optimalme-npd-poweruser]
output = json
region = ap-southeast-2
aws_access_key_id = xxxxx
aws_secret_access_key = xxxxx
aws_session_token = xxxxxxx
```

### Set up dev environment for amplify

If we are using aws SSO created by the above steps, we don't need to do `amplify configure`, go to `amplify init` or `amplify pull`


#### If you want to set up new app environment in AWS, use amplify init

```
amplify init

...
? Please choose the profile you want to use  <= select the profile created by Okta Auth script
...

```

After you make some changes on your amplify folder, if you want to apply your changes on AWS, run the command below
```
amplify push
```

It will create new app in AWS amplify


#### If you want to use the existing AWS environment to pull into your local, use amplify pull

Go to AWS amplify web page, and select APP(e.g. aspire)

then select Backend environments.

You can find something like below

```
amplify pull --appId d28kt9r3mum0vu --envName npd

...
? Please choose the profile you want to use  <= select the profile created by Okta Auth script
...

```

*IMPORTANT: it will overwrite your amplify folder. so you need to back up the folder if you have changes in the amplify folder.*

Eventually, what we need is aws-exports.js and team-provider-info.json files to sync the existing environment

